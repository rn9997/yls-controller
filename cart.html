<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart — Next-Life Loot</title>
  <meta name="description" content="Review your items, adjust quantities, and proceed to checkout." />
  <link rel="stylesheet" href="assets/styles.css" />

  <!-- Page-scoped layout safety net (keeps things aligned even if global CSS differs) -->
  <style>
    .cart-wrap{
      display:grid;
      grid-template-columns: minmax(0,1fr) 320px;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .cart-wrap{ grid-template-columns: 1fr }
      .summary{ position:static }
    }
    .summary{
      position:sticky; top:90px;
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg,#0c1017,#0a0e15);
      box-shadow:var(--shadow-md);
    }
    .summary .row + .row{ margin-top:8px }
    .cart-img{
      inline-size:64px; block-size:64px; object-fit:cover;
      border-radius:10px; border:1px solid var(--line);
    }
    .qty{ width:86px }
    .cart-actions{ white-space:nowrap }
    .w-100{ width:100% }
    .text-right{ text-align:right }
    .mb-2{ margin-bottom:12px }
    .mt-2{ margin-top:12px }
    .mt-3{ margin-top:18px }
    .fw-600{ font-weight:600 }
    .muted{ color:var(--muted) }
    .sr-only{
      position:absolute; inline-size:1px; block-size:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
    /* Make the table nicely scrollable on small screens */
    .table-wrap{ overflow:auto; border-radius:12px }
    .table th, .table td { vertical-align:middle }
    .btn[aria-disabled="true"]{ opacity:.6; pointer-events:none }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container nav">
      <div class="logo"><span class="badge" aria-hidden="true">✨</span>Next-Life Loot</div>

      <nav class="row" style="gap:10px" aria-label="Main navigation">
        <a class="btn ghost" href="index.html">Home</a>
        <a class="btn ghost" href="shop.html">Shop</a>
        <a class="btn ghost" href="contact.html">Contact</a>
      </nav>

      <div class="grow" aria-hidden="true"></div>

      <label for="ccy" class="sr-only">Currency</label>
      <select id="ccy" class="select" style="width:auto">
        <option value="BHD">BHD د.ب</option>
        <option value="USD">USD $</option>
        <option value="EUR">EUR €</option>
        <option value="GBP">GBP £</option>
      </select>
    </div>
  </header>

  <!-- Main -->
  <main class="container" id="main">
    <h1 class="headline mb-2">Your Cart</h1>

    <div id="emptyState" class="notice" style="display:none">
      <p class="small" style="margin:0">
        Your cart is empty.
        <a class="btn primary" href="shop.html" style="margin-inline-start:10px">Continue shopping</a>
      </p>
    </div>

    <section class="cart-wrap mt-2">
      <!-- Left: table -->
      <div class="table-wrap">
        <table class="table w-100" id="cartTable" aria-describedby="totals">
          <colgroup>
            <col style="width:52%">
            <col style="width:12%">
            <col style="width:18%">
            <col style="width:18%">
            <col>
          </colgroup>
          <thead>
            <tr>
              <th scope="col">Item</th>
              <th scope="col">Qty</th>
              <th scope="col">Price</th>
              <th scope="col">Total</th>
              <th scope="col"><span class="sr-only">Actions</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Right: summary -->
      <aside class="pad summary" id="totals" aria-live="polite">
        <div class="row spread">
          <span class="small">Subtotal</span>
          <strong id="subtotal">$0.00</strong>
        </div>
        <div class="row spread">
          <span class="small">VAT (demo)</span>
          <span id="vat" class="small">$0.00</span>
        </div>
        <hr style="border:none;border-top:1px solid var(--line)" class="mt-2 mb-2">
        <div class="row spread fw-600">
          <span class="small">Total</span>
          <strong id="grand">$0.00</strong>
        </div>

        <div class="row mt-3" style="gap:8px">
          <button class="btn ghost w-100" id="clearCart">Clear cart</button>
          <!-- If you already have checkout.html, this becomes a link; otherwise JS will alert -->
          <a class="btn primary w-100" id="checkout" href="checkout.html" aria-disabled="true">Checkout</a>
        </div>
        <p class="small muted mt-2">Payments coming soon (Stripe / PayPal / Tabby).</p>
      </aside>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">© <span id="year"></span> Next-Life Loot</footer>

  <!-- App script -->
  <script src="assets/app.js"></script>
  <script>
    (async function initCartPage(){
      bindHeader?.();

      const products = await loadProducts();
      const tbody = document.querySelector('#cartTable tbody');
      const emptyState = document.getElementById('emptyState');

      const els = {
        subtotal: document.getElementById('subtotal'),
        vat:      document.getElementById('vat'),
        grand:    document.getElementById('grand'),
        clear:    document.getElementById('clearCart'),
        checkout: document.getElementById('checkout'),
      };

      const VAT_RATE = 0.00; // set a real rate per region if needed

      // Render a single row
      function renderRow(p, qty){
        const tr = document.createElement('tr');
        const priceUSD = Number(p.priceUSD) || 0;
        const q = Math.max(1, Number(qty) || 1);
        const lineUSD = priceUSD * q;

        tr.innerHTML = `
          <td>
            <div class="row" style="gap:10px">
              <img class="cart-img" src="${p.img}" alt="${p.name}">
              <div>
                <div class="fw-600">${p.name}</div>
                <div class="small muted">${p.condition || ''}</div>
              </div>
            </div>
          </td>
          <td>
            <label class="sr-only" for="qty-${p.id}">Quantity for ${p.name}</label>
            <input id="qty-${p.id}" type="number" min="1" value="${q}" class="input qty" inputmode="numeric" pattern="[0-9]*">
          </td>
          <td data-price>${toMoney(STORE.getCurrency(), priceUSD)}</td>
          <td data-line>${toMoney(STORE.getCurrency(), lineUSD)}</td>
          <td class="cart-actions">
            <button class="btn ghost" data-remove>Remove</button>
          </td>
        `;

        // qty change
        tr.querySelector('.qty').addEventListener('change', (e) => {
          const v = Math.max(1, Number(e.target.value) || 1);
          e.target.value = v;
          STORE.setQty(p.id, v); // -> triggers 'cart:changed'
        });

        // remove
        tr.querySelector('[data-remove]').addEventListener('click', () => {
          STORE.remove(p.id); // -> triggers 'cart:changed'
        });

        return tr;
      }

      function computeAndRender(){
        // Build rows
        tbody.innerHTML = '';
        const cart = STORE.getCart();
        const entries = Object.entries(cart);

        let subUSD = 0;
        let count = 0;

        for(const [id, qtyRaw] of entries){
          const p = products.find(x => x.id === id);
          if(!p) continue;
          const q = Math.max(1, Number(qtyRaw) || 1);
          count += q;
          subUSD += (Number(p.priceUSD) || 0) * q;
          tbody.appendChild(renderRow(p, q));
        }

        const hasItems = count > 0;
        emptyState.style.display = hasItems ? 'none' : 'block';

        const vatUSD = subUSD * VAT_RATE;
        els.subtotal.textContent = toMoney(STORE.getCurrency(), subUSD);
        els.vat.textContent      = toMoney(STORE.getCurrency(), vatUSD);
        els.grand.textContent    = toMoney(STORE.getCurrency(), subUSD + vatUSD);

        // Enable/disable checkout
        els.checkout.setAttribute('aria-disabled', hasItems ? 'false' : 'true');
        if(!hasItems){
          // keep href for SEO but block click
          els.checkout.addEventListener('click', preventIfDisabledOnce, { once: true });
        }
      }

      function preventIfDisabledOnce(e){
        if (els.checkout.getAttribute('aria-disabled') === 'true'){
          e.preventDefault();
          alert('Your cart is empty.');
        }
      }

      // Clear cart
      els.clear.addEventListener('click', () => {
        if (confirm('Clear all items from your cart?')) {
          STORE.clear(); // -> triggers 'cart:changed'
        }
      });

      // If checkout.html doesn’t exist yet, keep a graceful fallback
      els.checkout.addEventListener('click', (e) => {
        if (els.checkout.getAttribute('aria-disabled') === 'true') return; // blocked above
        // If you don't have a checkout page yet, comment the next line and use alert instead.
        // window.location.href = els.checkout.getAttribute('href');
        // Fallback alert (remove once real checkout exists)
        // e.preventDefault();
        // alert('Checkout coming soon. Integrations: Stripe/PayPal/Tabby.');
      });

      // Re-render on store/currency events
      document.addEventListener('cart:changed', computeAndRender);
      document.addEventListener('currency:changed', computeAndRender);

      // Initial render + footer year
      computeAndRender();
      document.getElementById('year').textContent = new Date().getFullYear();
    })();
  </script>
</body>
</html>
